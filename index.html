<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ramadanly - Ultimate Companion</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        arab: ['Amiri', 'serif'],
                    },
                    colors: {
                        primary: '#10B981', 
                        secondary: '#064E3B',
                        accent: '#F59E0B',
                        dark: '#0F172A',
                        darkcard: '#1E293B'
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Styles */
        body { -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        .dark .glass {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        /* Audio Player Animation */
        .playing-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #10B981;
            border-radius: 50%;
            animation: pulse-green 2s infinite;
        }
        @keyframes pulse-green {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        /* Quran Reader Styles */
        .verse-container.active-verse {
            background-color: rgba(16, 185, 129, 0.1);
            border-right: 4px solid #10B981;
        }
        .dark .verse-container.active-verse {
            background-color: rgba(16, 185, 129, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-dark dark:text-gray-100 transition-colors duration-300 min-h-screen pb-24">

    <nav class="fixed top-0 w-full z-50 glass border-b border-gray-200 dark:border-gray-800 transition-all duration-300" id="navbar">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-kaaba text-primary text-2xl"></i>
                <h1 class="font-bold text-xl tracking-tight">Ramadanly</h1>
            </div>
            <div class="flex gap-3 items-center">
                <div class="text-xs text-right hidden md:block">
                    <p id="location-name" class="font-semibold text-primary">Mencari Lokasi...</p>
                    <p id="hijri-date" class="opacity-60">1 Ramadan 1445H</p>
                </div>
                <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                    <i class="fas fa-moon dark:hidden text-gray-600"></i>
                    <i class="fas fa-sun hidden dark:block text-yellow-400"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 pt-20">
        
        <section id="tab-home" class="tab-content block animate-fade-in">
            
            <div class="relative bg-gradient-to-br from-emerald-600 to-teal-800 rounded-2xl p-6 text-white shadow-xl overflow-hidden mb-6">
                <div class="absolute top-0 right-0 -mt-8 -mr-8 w-32 h-32 bg-white opacity-10 rounded-full blur-2xl"></div>
                <div class="text-center relative z-10">
                    <p class="text-emerald-100 text-sm font-medium uppercase tracking-widest mb-1">Menuju <span id="next-prayer-name">...</span></p>
                    <h1 id="countdown" class="text-5xl md:text-6xl font-bold font-mono my-2 tracking-tighter">00:00:00</h1>
                    <p id="geo-info" class="text-xs text-emerald-200 mt-2"><i class="fas fa-map-marker-alt"></i> Jakarta</p>
                    
                    <div class="mt-4 flex justify-center gap-2">
                        <button onclick="testAlarm()" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm px-4 py-1.5 rounded-full text-xs flex items-center gap-2 transition">
                            <i class="fas fa-volume-up"></i> Cek Suara
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-darkcard rounded-xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg"><i class="far fa-clock text-primary mr-2"></i>Jadwal Sholat</h3>
                        <span class="text-xs bg-emerald-100 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-300 px-2 py-1 rounded">Hari Ini</span>
                    </div>
                    <div id="prayer-list" class="space-y-2">
                        <div class="animate-pulse h-32 bg-gray-200 dark:bg-gray-700 rounded-lg"></div>
                    </div>
                </div>

                <div onclick="switchTab('quran')" class="bg-white dark:bg-darkcard rounded-xl shadow-sm p-5 border border-gray-100 dark:border-gray-700 cursor-pointer hover:border-primary transition group relative overflow-hidden">
                    <div class="absolute right-0 bottom-0 opacity-5 dark:opacity-10 transform translate-x-4 translate-y-4">
                        <i class="fas fa-quran text-9xl"></i>
                    </div>
                    <h3 class="font-bold text-lg mb-2"><i class="fas fa-book-open text-primary mr-2"></i>Lanjut Membaca</h3>
                    <div id="home-last-read" class="mt-4">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Belum ada riwayat bacaan.</p>
                        <p class="text-xs mt-1 text-primary">Mulai baca sekarang &rarr;</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-quran" class="tab-content hidden">
            <div class="sticky top-16 z-40 bg-white/90 dark:bg-dark/90 backdrop-blur pb-4 pt-2 mb-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex gap-2 mb-3" id="quran-search-bar">
                    <div class="relative flex-1">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        <input type="text" id="surah-search" placeholder="Cari Surah (cth: Yasin)..." 
                            class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800 focus:ring-2 focus:ring-primary focus:outline-none transition">
                    </div>
                </div>

                <div id="reader-controls" class="hidden flex flex-col gap-3 bg-gray-100 dark:bg-gray-800 p-3 rounded-lg">
                    <div class="flex justify-between items-center">
                        <button onclick="closeSurah()" class="text-sm px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300"><i class="fas fa-arrow-left"></i> Kembali</button>
                        <h3 id="active-surah-title" class="font-bold text-primary">Surah Name</h3>
                        <button onclick="toggleSettings()" class="text-gray-500 hover:text-primary"><i class="fas fa-cog"></i></button>
                    </div>
                    
                    <div id="font-settings" class="hidden border-t border-gray-300 dark:border-gray-600 pt-2 mt-2">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xs w-16">Font Arab:</span>
                            <input type="range" min="18" max="48" value="28" class="w-full accent-primary" id="font-size-arab" oninput="updateFontSize()">
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs w-16">Terjemahan:</span>
                            <input type="range" min="10" max="24" value="14" class="w-full accent-primary" id="font-size-latin" oninput="updateFontSize()">
                        </div>
                    </div>
                </div>
            </div>

            <div id="surah-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 pb-20">
                <div class="text-center py-10 text-gray-400">
                    <i class="fas fa-circle-notch fa-spin text-2xl"></i> Memuat Data Surah...
                </div>
            </div>

            <div id="verse-container" class="hidden space-y-4 pb-32">
                </div>
            
            <div id="audio-player-bar" class="fixed bottom-20 left-4 right-4 bg-dark text-white p-3 rounded-xl shadow-2xl flex items-center gap-3 hidden z-50 transform transition-transform">
                <div id="audio-info" class="flex-1 text-sm truncate">
                    <span class="font-bold text-emerald-400 block text-xs">Sedang Memutar</span>
                    <span id="audio-verse-name">Al-Fatihah : 1</span>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="prevVerse()" class="text-gray-400 hover:text-white"><i class="fas fa-step-backward"></i></button>
                    <button onclick="togglePlayPause()" id="play-pause-btn" class="w-10 h-10 bg-emerald-500 rounded-full flex items-center justify-center hover:bg-emerald-600 shadow-lg">
                        <i class="fas fa-play"></i>
                    </button>
                    <button onclick="nextVerse()" class="text-gray-400 hover:text-white"><i class="fas fa-step-forward"></i></button>
                </div>
            </div>
        </section>

        <section id="tab-ibadah" class="tab-content hidden space-y-6">
            
            <div class="bg-white dark:bg-darkcard rounded-xl p-5 shadow-sm border border-gray-100 dark:border-gray-700">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2 text-primary">
                    <i class="fas fa-check-double"></i> Checklist Harian
                </h3>
                <div class="space-y-3" id="checklist-container">
                    </div>
            </div>

            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-5 shadow-sm border border-blue-100 dark:border-blue-900">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-blue-600 dark:text-blue-400"><i class="fas fa-tint"></i> Air Minum (2-4-2)</h3>
                    <span id="water-count" class="font-bold text-2xl text-blue-600">0/8</span>
                </div>
                <div class="flex justify-center gap-2 flex-wrap" id="water-cups">
                    </div>
                <button onclick="resetWater()" class="mt-4 text-xs text-blue-500 hover:text-blue-700 w-full text-center">Reset Hari Ini</button>
            </div>

            <div class="bg-white dark:bg-darkcard rounded-xl p-5 shadow-sm text-center border border-gray-100 dark:border-gray-700">
                <h3 class="font-bold text-lg mb-2 text-primary">Tasbih Digital</h3>
                <div class="bg-gray-100 dark:bg-gray-800 rounded-2xl p-6 mb-4 relative overflow-hidden">
                    <span id="tasbih-count" class="text-6xl font-mono font-bold text-gray-700 dark:text-gray-200">0</span>
                    <button onclick="resetTasbih()" class="absolute top-2 right-2 text-gray-400 hover:text-red-500"><i class="fas fa-redo"></i></button>
                </div>
                <button onclick="countTasbih()" class="w-20 h-20 bg-emerald-500 hover:bg-emerald-600 rounded-full shadow-lg text-white text-3xl transition transform active:scale-90">
                    <i class="fas fa-fingerprint"></i>
                </button>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 w-full bg-white dark:bg-darkcard border-t border-gray-200 dark:border-gray-800 pb-safe pt-2 px-6 flex justify-between items-center z-50 h-16 shadow-[0_-5px_10px_rgba(0,0,0,0.05)]">
        <button onclick="switchTab('home')" class="nav-btn active flex flex-col items-center gap-1 text-gray-400 w-1/3">
            <i class="fas fa-home text-xl mb-0.5"></i>
            <span class="text-[10px] font-medium">Home</span>
        </button>
        <button onclick="switchTab('quran')" class="nav-btn flex flex-col items-center gap-1 text-gray-400 w-1/3">
            <i class="fas fa-book-quran text-xl mb-0.5"></i>
            <span class="text-[10px] font-medium">Al-Qur'an</span>
        </button>
        <button onclick="switchTab('ibadah')" class="nav-btn flex flex-col items-center gap-1 text-gray-400 w-1/3">
            <i class="fas fa-mosque text-xl mb-0.5"></i>
            <span class="text-[10px] font-medium">Ibadah</span>
        </button>
    </nav>

    <audio id="alarm-audio" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_0625c1539c.mp3?filename=islamic-prayer-azan-11656.mp3"></audio>
    <audio id="quran-audio"></audio>

    <script>
        // --- GLOBAL STATE ---
        let currentSurahData = null;
        let currentAudioIndex = -1;
        let audioList = [];
        let prayerTimes = {};
        let userLocation = { lat: -6.200000, lng: 106.816666, name: 'Jakarta' }; // Default

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initLocation(); // This triggers prayer fetch
            loadSurahList();
            renderChecklist();
            renderWater();
            loadTasbih();
            loadLastReadHome();
            
            // Tab handling
            window.switchTab('home');

            // Countdown Interval
            setInterval(updateCountdown, 1000);

            // Quran Audio Listener
            const audioPlayer = document.getElementById('quran-audio');
            audioPlayer.onended = () => {
                nextVerse();
            };
        });

        // --- 1. THEME & UI ---
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        }

        function switchTab(tabId) {
            // Hide all sections
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('block'));
            
            // Show target
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.add('block');

            // Update Nav Icons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-primary', 'font-bold');
                btn.classList.add('text-gray-400');
            });
            // Highlight active nav (simple matching based on index/order or onclick logic)
            // For simplicity, we just rely on the onclick adding a class in real apps, 
            // but here we map tabId to button index
            const map = { 'home': 0, 'quran': 1, 'ibadah': 2 };
            const btns = document.querySelectorAll('.nav-btn');
            btns[map[tabId]].classList.add('text-primary');
            btns[map[tabId]].classList.remove('text-gray-400');
        }

        // --- 2. PRAYER TIMES & LOCATION ---
        function initLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    userLocation.lat = position.coords.latitude;
                    userLocation.lng = position.coords.longitude;
                    document.getElementById('geo-info').innerHTML = `<i class="fas fa-map-marker-alt"></i> Lokasi Terdeteksi`;
                    document.getElementById('location-name').textContent = "Lokasi Saya";
                    fetchPrayerTimes();
                }, () => {
                    alert("Gagal deteksi lokasi. Menggunakan Jakarta.");
                    fetchPrayerTimes();
                });
            } else {
                fetchPrayerTimes();
            }
        }

        async function fetchPrayerTimes() {
            const date = new Date();
            // API: Aladhan (Method 20 = Kemenag RI)
            const url = `https://api.aladhan.com/v1/timings/${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}?latitude=${userLocation.lat}&longitude=${userLocation.lng}&method=20`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                prayerTimes = data.data.timings;
                document.getElementById('hijri-date').textContent = `${data.data.date.hijri.day} ${data.data.date.hijri.month.en} ${data.data.date.hijri.year}`;
                renderPrayerSchedule();
            } catch (e) {
                console.error(e);
            }
        }

        function renderPrayerSchedule() {
            const list = document.getElementById('prayer-list');
            list.innerHTML = '';
            
            const mapping = [
                { k: 'Imsak', n: 'Imsak', i: 'fa-cloud-moon' },
                { k: 'Fajr', n: 'Subuh', i: 'fa-sun' },
                { k: 'Sunrise', n: 'Terbit', i: 'fa-mountain' }, // Syuruq
                { k: 'Dhuhr', n: 'Zuhur', i: 'fa-sun' },
                { k: 'Asr', n: 'Ashar', i: 'fa-cloud-sun' },
                { k: 'Maghrib', n: 'Maghrib', i: 'fa-moon' },
                { k: 'Isha', n: 'Isya', i: 'fa-star' }
            ];

            mapping.forEach(p => {
                const time = prayerTimes[p.k];
                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition border-b border-gray-100 dark:border-gray-700 last:border-0";
                div.id = `prayer-${p.k}`;
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-emerald-100 dark:bg-emerald-900 text-emerald-600 dark:text-emerald-400 flex items-center justify-center text-xs">
                            <i class="fas ${p.i}"></i>
                        </div>
                        <span class="font-medium">${p.n}</span>
                    </div>
                    <span class="font-bold font-mono text-lg tracking-wider">${time}</span>
                `;
                list.appendChild(div);
            });
            highlightNextPrayer();
        }

        function highlightNextPrayer() {
            // Logic to find next prayer similar to previous version
            // Simplified for brevity in this "Ultimate" code
            // (Assuming standard logic comparing HH:MM)
            const now = new Date();
            const curTime = now.getHours() * 60 + now.getMinutes();
            let nextKey = 'Imsak'; // Default to next day
            let minDiff = 9999;
            let targetTimeObj = null;

            const keys = ['Imsak', 'Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            
            for (let key of keys) {
                const [h, m] = prayerTimes[key].split(':').map(Number);
                const pTime = h * 60 + m;
                const diff = pTime - curTime;
                
                if (diff > 0 && diff < minDiff) {
                    minDiff = diff;
                    nextKey = key;
                    const t = new Date();
                    t.setHours(h, m, 0);
                    targetTimeObj = t;
                }
            }

            // UI Updates
            document.querySelectorAll('[id^="prayer-"]').forEach(el => el.classList.remove('bg-emerald-50', 'dark:bg-emerald-900/30', 'border-l-4', 'border-primary'));
            const activeEl = document.getElementById(`prayer-${nextKey}`);
            if(activeEl) {
                activeEl.classList.add('bg-emerald-50', 'dark:bg-emerald-900/30', 'border-l-4', 'border-primary');
            }

            document.getElementById('next-prayer-name').textContent = nextKey;
            window.nextPrayerTime = targetTimeObj;
        }

        function updateCountdown() {
            if(!window.nextPrayerTime) return;
            const now = new Date();
            const diff = window.nextPrayerTime - now;

            if (diff <= 0) {
                document.getElementById('countdown').textContent = "00:00:00";
                // Play Adzan if diff is just reached
                if (diff > -2000) document.getElementById('alarm-audio').play().catch(e=>console.log("Audio block"));
                return;
            }

            const h = Math.floor(diff / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            document.getElementById('countdown').textContent = `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        function testAlarm() {
            const audio = document.getElementById('alarm-audio');
            audio.currentTime = 0;
            audio.play();
        }

        // --- 3. QURAN ENGINE (The Big Feature) ---
        async function loadSurahList() {
            try {
                const res = await fetch('https://api.alquran.cloud/v1/surah');
                const data = await res.json();
                const container = document.getElementById('surah-list');
                container.innerHTML = '';

                data.data.forEach(s => {
                    const card = document.createElement('div');
                    card.className = "bg-white dark:bg-darkcard p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 cursor-pointer hover:border-primary hover:shadow-md transition flex justify-between items-center group";
                    card.onclick = () => openSurah(s.number, s.englishName);
                    
                    card.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-gray-100 dark:bg-gray-800 rounded-lg flex items-center justify-center font-bold text-gray-500 group-hover:bg-primary group-hover:text-white transition">
                                ${s.number}
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800 dark:text-gray-200">${s.englishName}</h4>
                                <p class="text-xs text-gray-500">${s.englishNameTranslation} • ${s.numberOfAyahs} Ayat</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="font-arab text-xl font-bold text-gray-600 dark:text-gray-400 group-hover:text-primary transition">${s.name.replace('سُورَةُ ', '')}</span>
                        </div>
                    `;
                    container.appendChild(card);
                });

                // Setup Search
                document.getElementById('surah-search').addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    Array.from(container.children).forEach(child => {
                        const text = child.innerText.toLowerCase();
                        child.style.display = text.includes(term) ? 'flex' : 'none';
                    });
                });

            } catch (e) {
                alert("Gagal memuat daftar surah. Cek koneksi internet.");
            }
        }

        async function openSurah(number, name) {
            // UI Switch
            document.getElementById('surah-list').classList.add('hidden');
            document.getElementById('quran-search-bar').classList.add('hidden');
            document.getElementById('verse-container').classList.remove('hidden');
            document.getElementById('reader-controls').classList.remove('hidden');
            document.getElementById('reader-controls').classList.add('flex');
            document.getElementById('active-surah-title').textContent = name;
            
            // Show Loading
            const vContainer = document.getElementById('verse-container');
            vContainer.innerHTML = '<div class="text-center py-20"><i class="fas fa-spinner fa-spin text-4xl text-primary"></i><p class="mt-4">Mengambil data ayat & audio...</p></div>';

            try {
                // Fetch Audio, Text, Translation
                // Using method: fetch editions. We need 3: quran-uthmani (text), ar.alafasy (audio), id.indonesian (translation)
                const res = await fetch(`https://api.alquran.cloud/v1/surah/${number}/editions/quran-uthmani,ar.alafasy,id.indonesian`);
                const data = await res.json();
                
                const arabicData = data.data[0].ayahs;
                const audioData = data.data[1].ayahs;
                const transData = data.data[2].ayahs;

                currentSurahData = { number: number, name: name, ayahs: [] };
                audioList = [];

                vContainer.innerHTML = ''; // Clear loading

                // Bismillah handling (except Surah 1 & 9)
                if (number !== 1 && number !== 9) {
                    vContainer.innerHTML += `<div class="text-center font-arab text-2xl py-6 opacity-80">بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ</div>`;
                }

                arabicData.forEach((ayah, index) => {
                    const audioSrc = audioData[index].audio;
                    const translation = transData[index].text;
                    const ayahNum = ayah.numberInSurah;
                    
                    audioList.push(audioSrc);
                    currentSurahData.ayahs.push({ num: ayahNum, text: ayah.text });

                    const verseDiv = document.createElement('div');
                    verseDiv.className = "verse-container bg-white dark:bg-darkcard p-4 rounded-xl border-b border-gray-100 dark:border-gray-800 transition scroll-mt-32";
                    verseDiv.id = `verse-${index}`;
                    verseDiv.onclick = () => playAudio(index); // Click to play

                    verseDiv.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <span class="bg-gray-100 dark:bg-gray-700 text-xs px-2 py-1 rounded-full text-gray-500">${number}:${ayahNum}</span>
                            <div class="flex gap-3">
                                <button onclick="bookmark(${number}, ${ayahNum}, '${name}'); event.stopPropagation();" class="text-gray-300 hover:text-accent transition">
                                    <i class="fas fa-bookmark"></i>
                                </button>
                                <button onclick="playAudio(${index}); event.stopPropagation();" class="text-primary hover:text-emerald-700">
                                    <i class="fas fa-play-circle text-xl"></i>
                                </button>
                            </div>
                        </div>
                        <p class="font-arab text-right leading-loose mb-4 quran-text" style="font-size: 28px;">${ayah.text}</p>
                        <p class="text-gray-600 dark:text-gray-400 text-sm leading-relaxed latin-text">${translation}</p>
                    `;
                    vContainer.appendChild(verseDiv);
                });

                // Check font preferences
                updateFontSize();

            } catch (e) {
                vContainer.innerHTML = '<p class="text-center text-red-500">Gagal memuat ayat.</p>';
                console.error(e);
            }
        }

        function closeSurah() {
            // Stop Audio
            const player = document.getElementById('quran-audio');
            player.pause();
            document.getElementById('audio-player-bar').classList.add('hidden');
            document.querySelectorAll('.active-verse').forEach(el => el.classList.remove('active-verse'));

            // UI Switch Back
            document.getElementById('surah-list').classList.remove('hidden');
            document.getElementById('quran-search-bar').classList.remove('hidden');
            document.getElementById('verse-container').classList.add('hidden');
            document.getElementById('reader-controls').classList.add('hidden');
            document.getElementById('reader-controls').classList.remove('flex');
        }

        // --- QURAN AUDIO PLAYER & SETTINGS ---
        function toggleSettings() {
            document.getElementById('font-settings').classList.toggle('hidden');
        }

        function updateFontSize() {
            const sizeArab = document.getElementById('font-size-arab').value;
            const sizeLatin = document.getElementById('font-size-latin').value;
            
            document.querySelectorAll('.quran-text').forEach(el => el.style.fontSize = `${sizeArab}px`);
            document.querySelectorAll('.latin-text').forEach(el => el.style.fontSize = `${sizeLatin}px`);
        }

        function playAudio(index) {
            if (index >= audioList.length) return; // End of Surah

            currentAudioIndex = index;
            const player = document.getElementById('quran-audio');
            const playerBar = document.getElementById('audio-player-bar');
            
            // Update Source
            if (player.src !== audioList[index]) {
                player.src = audioList[index];
            }
            player.play();

            // UI Updates
            playerBar.classList.remove('hidden');
            playerBar.classList.add('flex');
            document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-pause"></i>';
            document.getElementById('audio-verse-name').textContent = `${currentSurahData.name} : ${currentSurahData.ayahs[index].num}`;

            // Highlight Verse
            document.querySelectorAll('.active-verse').forEach(el => el.classList.remove('active-verse'));
            const row = document.getElementById(`verse-${index}`);
            if(row) {
                row.classList.add('active-verse');
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function togglePlayPause() {
            const player = document.getElementById('quran-audio');
            if (player.paused) {
                player.play();
                document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-pause"></i>';
            } else {
                player.pause();
                document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-play"></i>';
            }
        }

        function nextVerse() {
            playAudio(currentAudioIndex + 1);
        }

        function prevVerse() {
            if (currentAudioIndex > 0) playAudio(currentAudioIndex - 1);
        }

        // --- BOOKMARKING ---
        function bookmark(surah, ayah, name) {
            const data = { surah, ayah, name, time: new Date().toISOString() };
            localStorage.setItem('ramadanly_bookmark', JSON.stringify(data));
            
            // Update Home Widget
            loadLastReadHome();
            alert(`Ditandai: ${name} Ayat ${ayah}`);
        }

        function loadLastReadHome() {
            const saved = localStorage.getItem('ramadanly_bookmark');
            if (saved) {
                const data = JSON.parse(saved);
                const html = `
                    <div class="flex items-center justify-between bg-emerald-50 dark:bg-emerald-900/20 p-3 rounded-lg border border-emerald-100 dark:border-emerald-800">
                        <div>
                            <p class="font-bold text-emerald-800 dark:text-emerald-400">${data.name}</p>
                            <p class="text-xs text-gray-500">Ayat ${data.ayah}</p>
                        </div>
                        <i class="fas fa-chevron-right text-emerald-500"></i>
                    </div>
                `;
                document.getElementById('home-last-read').innerHTML = html;
                
                // Add click event to home widget to jump to surah (Simple implementation: just open surah list for now or logic to auto scroll)
                // For simplicity: opens surah list
            }
        }

        // --- TOOLS (CHECKLIST, WATER, TASBIH) ---
        // Checklist
        const tasks = [
            {id:'fajr', l:'Sholat Subuh'}, {id:'zuhur', l:'Sholat Zuhur'}, {id:'asr', l:'Sholat Ashar'},
            {id:'maghrib', l:'Sholat Maghrib'}, {id:'isha', l:'Sholat Isya'}, {id:'tarawih', l:'Tarawih'},
            {id:'tilawah', l:'Tilawah Quran'}, {id:'sedekah', l:'Sedekah'}
        ];
        function renderChecklist() {
            const dateKey = new Date().toDateString();
            const saved = JSON.parse(localStorage.getItem(`check_${dateKey}`) || '{}');
            const con = document.getElementById('checklist-container');
            con.innerHTML = '';
            
            tasks.forEach(t => {
                const checked = saved[t.id];
                const div = document.createElement('div');
                div.className = `flex items-center p-3 rounded-lg border cursor-pointer transition ${checked ? 'bg-emerald-50 border-emerald-200 dark:bg-emerald-900/20 dark:border-emerald-800' : 'bg-white border-gray-200 dark:bg-darkcard dark:border-gray-700'}`;
                div.onclick = () => {
                    saved[t.id] = !saved[t.id];
                    localStorage.setItem(`check_${dateKey}`, JSON.stringify(saved));
                    renderChecklist();
                };
                div.innerHTML = `
                    <div class="w-5 h-5 rounded border flex items-center justify-center mr-3 ${checked ? 'bg-primary border-primary text-white' : 'border-gray-300'}">
                        ${checked ? '<i class="fas fa-check text-xs"></i>' : ''}
                    </div>
                    <span class="${checked ? 'line-through text-gray-400' : ''}">${t.l}</span>
                `;
                con.appendChild(div);
            });
        }

        // Water
        function renderWater() {
            const dateKey = `water_${new Date().toDateString()}`;
            const count = parseInt(localStorage.getItem(dateKey) || '0');
            const max = 8;
            
            document.getElementById('water-count').textContent = `${count}/${max}`;
            const cupsCon = document.getElementById('water-cups');
            cupsCon.innerHTML = '';
            
            for(let i=0; i<max; i++) {
                const btn = document.createElement('button');
                btn.className = `w-8 h-8 rounded-full border border-blue-200 flex items-center justify-center transition ${i < count ? 'bg-blue-500 text-white shadow-lg transform scale-110' : 'bg-white text-gray-200'}`;
                btn.innerHTML = '<i class="fas fa-glass-water text-xs"></i>';
                btn.onclick = () => {
                    const newCount = i < count ? i : i+1; // Toggle logic simplified to incremental
                    localStorage.setItem(dateKey, i+1);
                    renderWater();
                };
                cupsCon.appendChild(btn);
            }
        }
        function resetWater() {
            localStorage.setItem(`water_${new Date().toDateString()}`, 0);
            renderWater();
        }

        // Tasbih
        function loadTasbih() {
            const count = localStorage.getItem('tasbih_count') || 0;
            document.getElementById('tasbih-count').textContent = count;
        }
        function countTasbih() {
            let c = parseInt(document.getElementById('tasbih-count').textContent);
            c++;
            document.getElementById('tasbih-count').textContent = c;
            localStorage.setItem('tasbih_count', c);
            
            // Haptic
            if(navigator.vibrate) navigator.vibrate(50);
            if(c % 33 === 0 && navigator.vibrate) navigator.vibrate([50, 50, 50]);
        }
        function resetTasbih() {
            if(confirm('Reset hitungan tasbih?')) {
                document.getElementById('tasbih-count').textContent = '0';
                localStorage.setItem('tasbih_count', 0);
            }
        }

    </script>
</body>
</html>
